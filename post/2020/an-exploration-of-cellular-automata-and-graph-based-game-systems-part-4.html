<!DOCTYPE html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width" />

	<title>An Exploration of Cellular Automata and Graph Based Game Systems: Part 4</title>

	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/normalize.css" />
	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/foundation.min.css" />
	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/style.css" />
	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/pygments.css" />
	<script src="//blog.macuyiko.com/theme/js/jquery-3.4.1.min.js"></script>
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css?family=Bitter:400,700|Source+Code+Pro&display=swap" rel="stylesheet">


	<script type="text/javascript">
		var waitForFinalEvent = (function () {
			var timers = {};
			return function (callback, ms, uniqueId) {
				if (!uniqueId) uniqueId = "_";
				if (timers[uniqueId]) clearTimeout(timers[uniqueId]);
				timers[uniqueId] = setTimeout(callback, ms);
			};
		})();
		var insertCaptions = function () {
			$('#articlecontainer .caption').remove();
			var width = $(window).width();
			var onmobile = width < 1400; //>
			var capclass = onmobile ? 'caption-below' : 'caption-aside';
			$.each($('#articlecontainer img'), function (index, value) {
				if ($(value).attr('alt') != undefined) {
					var elem = $('<div class="caption ' + capclass + '">' + $(value).attr('alt') + '</div>');
					if (onmobile) elem.insertAfter(value);
					else elem.insertBefore(value);
				}
			});
		};
		$(function () {
			$(window).resize(function () {
				waitForFinalEvent(function () {
					insertCaptions();
				}, 500, "window.resize");
			});
			insertCaptions();
		});
	</script>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-60406-11']);
		_gaq.push(['_trackPageview']);

		(function () {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
</head>

<body>

	<nav>
		<div class="top-bar large-12 columns">
			<h1><a href="//blog.macuyiko.com/">Bed Against The Wall</a></h1>
		</div>
	</nav>

	<div class="postheader">
		<div class="postheader-wrap">
			<img class="postheader-trans" src="data:image/gif;base64,R0lGODlhMgAVAPAAAP///wAAACH5BAEAAAAALAAAAAAyABUAAAIfhI+py+0Po5y02ouz3rz7D4biSJbmiabqyrbuC8dTAQA7">
			<img class="postheader-cover" src="/images/backgrounds/noita.jpg">
		</div>
	</div>

	<div class="row contentwrapper">
		<div class="row">
<div id="articlecontainer" class="large-9 columns large-centered">
	<article>
		<header>
			<div class="article-info">Sun 08 November 2020, by Seppe "Macuyiko" vanden Broucke</div>
			<div class="article-title"><a href="//blog.macuyiko.com/post/2020/an-exploration-of-cellular-automata-and-graph-based-game-systems-part-4.html" rel="bookmark"
			title="Permalink to An Exploration of Cellular Automata and Graph Based Game Systems: Part 4">An Exploration of Cellular Automata and Graph Based Game Systems: Part&nbsp;4</a></div>
<div class="article-subtitle">Revisiting the Topic with an Alternative Approach</div>		</header>
	
	    <script>
$(function() {
    $('.toggle').each(function(index) {
        var toggler = $('<div style="margin: 8px 0; background-color: #E3E0FF; cursor: pointer; padding: 8px;">Toggle iframe</div>');
        toggler.insertBefore($(this));
        toggler.click(function() {
            var elt = $(this).next('.toggle');
            var newElt = $("<iframe></iframe>")
            Array.prototype.slice.call(elt.get(0).attributes).forEach(function(a) {
                newElt.attr(a.name, a.value);
            });
            if (!$(this).hasClass('toggled')) {
                elt.append(newElt);
                $(this).addClass('toggled');
            } else {
                elt.html('');
                $(this).removeClass('toggled');
            }
        });
    });
});
</script>

<p>This post is the fourth part on a small series on cellular automata and graph based systems as found in games. Part 1 can be found <a href="////blog.macuyiko.com/post/2017/an-exploration-of-cellular-automata-and-graph-based-game-systems-part-1.html">here</a>, part 2 is over <a href="////blog.macuyiko.com/post/2017/an-exploration-of-cellular-automata-and-graph-based-game-systems-part-2.html">here</a> and part 3 is <a href="////blog.macuyiko.com/post/2018/an-exploration-of-cellular-automata-and-graph-based-game-systems-part-3.html">here</a>. Especially parts 1 and 2 are worth reading if you&#8217;re just catching&nbsp;up.</p>
<p>This series started at the end of 2017 and was finished in 2018 (time flies). This part was hence unplanned but I wanted to add some additional thoughts. Since I wrote the original series, <a href="https://store.steampowered.com/app/881100/Noita/">Noita</a> came out, a game which make the &#8220;falling sand&#8221; style of games part of its engine, proudly boasting that &#8220;every pixel is simulated&#8221;. It&#8217;s a very fun game, and a dream come true for fans of the <a href="https://en.wikipedia.org/wiki/Cellular_automaton">cellular automaton</a> (<span class="caps">CA</span>). Or is&nbsp;it?</p>
<p>Whilst playing the game, I was impressed with the engine being capable to simulate huge worlds, without slowing down (well &#8212; it <em>does</em> slow down, but only once you start unleashing real chaos). Based on some reading and some <a href="https://news.ycombinator.com/item?id=23649419">earlier discussion on Hacker News</a>, it seemed to me that this was based on a traditional cellular automaton system, which can be easily made multi-threaded: just distribute the cells over the thread pool. As each cell&#8217;s new state is determined by its current environment, and all cells&#8217; new state is calculated before &#8220;flipping the buffer&#8221;, this is&nbsp;easy.</p>
<p>However, given the scale of the game map, it also seemed that something more clever was going on. My hunch at the time was the grid is probably divided into blocks or chunks, with only the chunks close enough to the player being updated (or based on distance to other important&nbsp;triggers).</p>
<h1><span class="caps">GDC</span> to the&nbsp;Rescue</h1>
<p>A couple of months ago, I returned to the topic and tried to investigate the Noita engine a bit more in depth. By then, the developers had given a <a href="https://www.youtube.com/watch?v=prXuyMCgbTc">presentation at <span class="caps">GDC</span></a> which I wholeheartedly recommend to watch for anyone with an interest in the topic. A couple of highlights stood&nbsp;out.</p>
<p>First, the speaker goes over the basics (and <span class="caps">BASIC</span>, too) of falling sand games quite extensively. This shows an implementation which does not rely on a real <span class="caps">CA</span>, but rather on a single-buffered version of the game which loops over the grid bottom-up, something like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="nv">each</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">starting</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">bottom</span>:
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nv">each</span><span class="w"> </span><span class="nv">column</span>:
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s sand at (row, column):</span>
<span class="w">            </span><span class="nv">drop</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">down</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
<span class="w">            </span><span class="nv">drop</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">down</span><span class="o">-</span><span class="nv">right</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
<span class="w">            </span><span class="nv">drop</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">down</span><span class="o">-</span><span class="nv">left</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
</code></pre></div>

<p>This works fine if you&#8217;re only simulating a couple of materials (sand and empty space) which behave&nbsp;similarly.</p>
<p><img alt="Screenshot from the presentation" src="/images/2020/gdc_noita1.png"></p>
<p>It is still relatively easy to add in water, which is very much like sand, except&nbsp;that:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="nv">each</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">starting</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">bottom</span>:
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nv">each</span><span class="w"> </span><span class="nv">column</span>:
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s sand at (row, column):</span>
<span class="w">            </span><span class="nv">drop</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">down</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
<span class="w">            </span><span class="nv">drop</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">down</span><span class="o">-</span><span class="nv">right</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
<span class="w">            </span><span class="nv">drop</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">down</span><span class="o">-</span><span class="nv">left</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s water at (row, column):</span>
<span class="w">            </span><span class="nv">drop</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">down</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
<span class="w">            </span><span class="nv">drop</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">down</span><span class="o">-</span><span class="nv">right</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
<span class="w">            </span><span class="nv">drop</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">down</span><span class="o">-</span><span class="nv">left</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
<span class="w">            </span><span class="nv">move</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">right</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
<span class="w">            </span><span class="nv">move</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">left</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">there</span><span class="err">&#39;s empty space</span>
</code></pre></div>

<p>Sound&#8217;s easy right? Well, if you&#8217;re like me and have spent a couple of hours implementing a <span class="caps">CA</span>-style engine to do this, you might&nbsp;argue:</p>
<ul>
<li>What if we want sand to float to the top of water? Can non-empty pixels displace each&nbsp;other?</li>
<li>Based on the <code>for each column</code> loop, water will have a tendency to move right-wards (or left-wards, which-ever check is performed&nbsp;first)</li>
<li>How does this scale to more materials with more complex&nbsp;interactions?</li>
<li>Specifically, what if we add gasses which should go upwards? The whole reason one typically implements a bottom-up loop is because of the assumption of gravity. If we would go top-down, the simulation will quickly enter a&nbsp;gap-pattern:</li>
</ul>
<p><img alt="Illustration of the gap pattern Issue" src="/images/2020/cel_gap.png"></p>
<p>The figure above shows five steps of a simulation where we&#8217;d be using a top-down loop. In the first time step, we&#8217;ve just drawn five water droplets above each other. For the second frame, the game loops over the first four, but can&#8217;t move them down (assume we&#8217;re moving downwards only for now) as there&#8217;s another pixel blocking them. The fifth (lowest) pixel can be moved down. For the third frame, the same problem occurs again for the top three pixels. The second to last pixel can be moved down (as there&#8217;s an empty spot not), and the fifth pixel can be moved down as well. This naturally leads to a dispersed one-in-between&nbsp;pattern.</p>
<p>Hower, with materials moving upwards (e.g. steam), the issue will reappear with a bottom-up style&nbsp;loop.</p>
<p>So okay, let&#8217;s argue that it&#8217;s a simplification for the sake of the presentation, as we can observe that the Noita engine is more involved. Let&#8217;s continue. The presenter shows a simple game with only one simulated liquid (blood), but with a nice trick that rigid physics bodies can interact with pixels and displace them further&nbsp;away.</p>
<blockquote>
<p>When the player jumps in the blood, it takes the surrounding pixels and puts them in a particle simulation with velocity and gravity. This can make liquids look less blobby and we&#8217;re still using this.&nbsp;[paraphrased]</p>
</blockquote>
<p>This is extremely neat. We won&#8217;t dive into that idea here, but might later. The approach to move pixels into a particle simulation is interesting, as well as the interaction with rigid bodies which themselves can be placed in and out the simulation by applying marching squares is very nice (as shown later in the&nbsp;presentation).</p>
<p>Next up, the multithreading aspect is discussed. To do so, the world is indeed divided into chunks. Each chunk keeps a dirty rect of things to be updated to limit the simulation. It gets a bit technical here, but something crucial is&nbsp;revealed:</p>
<blockquote>
<p>The problem with adding multithreading is that it uses the same buffer. There&#8217;s no two buffers. So you need to make sure the same pixel is not updated by multiple threads.&nbsp;[paraphrased]</p>
</blockquote>
<p>The solution presented is a checkboard style update, but what stood out to me was the fact that the approach taken is still a single buffer, pixel-oriented approach, very much in line with the <span class="caps">BASIC</span> example showed earlier. There&#8217;s one last notable remark&nbsp;here.</p>
<blockquote>
<p>We guarantee that no pixel can be moved more than 32 pixels away.&nbsp;[paraphrased]</p>
</blockquote>
<p>In summary, the talk is very revealing. The remainder of it goes over the design. It does leave us hanging a bit in terms of the exact details and whether Noita really doesn&#8217;t use a <span class="caps">CA</span> approach. One of the audience members in fact asks the same question (around&nbsp;28:00):</p>
<blockquote>
<p>You mentioned that the simulation is single buffered, did you try double buffering?
- This is just how we got going. But later on I also noticed that when you do double buffering, you have to update everything even when applying multi threading.
- I think you can do all sorts of simulations double buffered, but it seems much harder as you need to figure out where each pixel needs to go.&nbsp;[paraphrased]</p>
</blockquote>
<p>It&#8217;s a quick question and a quick answer, but it completely threw me off after the first watching. Indeed, when you double buffer, you&#8217;d basically have to update the entire grid. This is what the multi threaded <span class="caps">CA</span> solution as mentioned at the beginning boils down to. The second part of the answer is even more revealing and contradictory for <span class="caps">CA</span>-fans, in the sense that it&#8217;s not really about figuring out where each pixel needs to go, it&#8217;s about how the state of each grid cell should change based on its environment. That is a fundamentally different approach, but on the other hand I can&#8217;t argue with practice: the Noita engine takes the pixels-as-objects approach and&nbsp;works.</p>
<p>So how does it work and maintain a believable&nbsp;simulation?</p>
<h1>Looking for&nbsp;Solutions</h1>
<p>The next step was trying to Google around for open source implementations of the idea, directly inspired by the talk. The only solid thing (well, apart from older falling sand games, of course), was <a href="https://www.reddit.com/r/gamedev/comments/d93op6/noita_pixel_simulation_any_tip_about_how_is_it/">this reddit discussion</a> as well as <a href="https://www.reddit.com/r/noita/comments/diow45/how_noita_pixel_simulation_works_does_anyone_know/">this one</a>. As always, not everything is directly&nbsp;helpful:</p>
<blockquote>
<p>My surprise was that they don&#8217;t double buffer. Most programs involve drawing to a buffer rather than directly on screen when the frame is being&nbsp;assembled.</p>
</blockquote>
<p>As commenters argue, the discussion has nothing to do with double or triple <em>frame</em> buffering. We&#8217;re only talking about the pixel simulation engine. The actual drawing routines are of course multiple-buffered and draw <span class="caps">UI</span> as well as particle elements on top. In fact, we&#8217;ve just seen how a lot of Noita&#8217;s believability comes from a particle system which pretends its adding in simulated pixels. Spell, splash, and explosion effects for instance. That&#8217;s an amazing feat in itself, but we&#8217;re razor focused on the simulation engine&nbsp;here.</p>
<p>Stuck deep in some of those comments, I also found <a href="https://www.youtube.com/watch?v=VLZjd_Y1gJ8">this YouTube video</a> (Recreating Noita&#8217;s Sand Simulation in C and OpenGL | Game Engineering) which actually puts out code and tries to follow the same approach. And what do you know, it looks like it&nbsp;works:</p>
<p><img alt="Screenshot from the video" src="/images/2020/gdc_noita3.png"></p>
<p>I especially like how the sand mingles with the water. This is exactly what I was referring to above and the <span class="caps">GDC</span> video didn&#8217;t directly address. Noita heavily simulates materials with different densities, so in case you want to simulate pixels-as-objects, they need to be able to displace other&nbsp;pixels.</p>
<p>Fantastically, the author of the video also <a href="https://github.com/GameEngineering/EP01_SandSim">makes their code available</a>. A quick perusal through the source code confirms it follows very much the non-<span class="caps">CA</span> style, and we can play around with the binary. The simulation is very solid (even although the code reveals that the author also had a hard time with some aspects which arise in a single-buffered&nbsp;engine):</p>
<p><img alt="Playing around" src="/images/2020/gdc_noita4.png"></p>
<p>What I especially like is that here too, materials are displaced and are moving further away than their immediate <a href="https://en.wikipedia.org/wiki/Moore_neighborhood">Moore neighborhood</a>. At first, this sounds messy to simulate, but the Noita video shows the same&nbsp;thing:</p>
<p><img alt="Pixels can move around a lot" src="/images/2020/gdc_noita2.png"></p>
<p>In fact, this helps to alleviate the problem of the &#8220;gap&#8221; pattern as mentioned above. The result is somewhat more random, looking movement, but actually helps to increase&nbsp;realism.</p>
<p>I was kind off planning to leave it here and conclude that single-buffered pixel-as-object approaches are indeed a fine alternative for <span class="caps">CA</span>. Remember that the last thing we did&nbsp;was:</p>
<div src="/iframes/cellular2/index.lava.html"
    class="toggle" scrolling="no" frameborder="0" width="520" height="320"></div>

<p>(You can play around with the simulation above. Pressing <code>o</code> cycles through the different material types to draw, <code>p</code> (un)pauses the simulation, <code>d</code> toggles debugging mode. Press <code>r</code> to reset everything. The initial setup loads in a closed system where water is heated, cycled, and cooled&nbsp;down.)</p>
<p>Even if this alternative sometimes encounters a situation where a pixel is destroyed (and hence cannot deterministally represent a closed loop system), it would be acceptable in a game&nbsp;environment.</p>
<p>But there was one more thing I wanted to try. Image we make an hourglass style setup with sand at the top part and steam at the bottom, and then open up the middle&nbsp;part:</p>
<p><img alt="Hmmm..." src="/images/2020/gdc_noita5.png"></p>
<p>That&#8217;s no good. The steam particles are blocking the sand. Okay, this doesn&#8217;t happen with water, and steam disappears over time so this issue resolves itself quite quickly. Still, the Noita engine seems to be more clever&nbsp;here.</p>
<p>With that noted, I wanted to see what a minimal implementation which would be able to handle this would look like. To summarize, we&#8217;re going to start by implementing a single-buffer, pixels-as-objects, non-<span class="caps">CA</span> approach, without the particle system, rigid bodies, higher-than-Moore rank neighborhoods, multi-threading and shaders (which are used to make e.g. bodies of water more fluid-behaving). In other words, we won&#8217;t go nearly as far as Noita&#8217;s Falling Everything engine, but we do want to prove that the approach can work, and also illustrate some of the problems compared with a <span class="caps">CA</span>&nbsp;approach.</p>
<h1>A Minimal&nbsp;Implementation</h1>
<p>Let us start with a basic illustration. We&#8217;re going to construct a grid of cells, allow for three types of materials (walls, sand, and water), and then simply loop over each pixel from bottom to top like&nbsp;so:</p>
<div class="highlight"><pre><span></span><code><span class="nx">visit_grid</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">nrRows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">--</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">nrCols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="nx">func</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">visit_pixels</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">visit_grid</span><span class="p">(</span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">getPixel</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="nx">func</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p>We can then update all pixels every game&nbsp;loop:</p>
<div class="highlight"><pre><span></span><code><span class="k">this</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">visit_pixels</span><span class="p">(</span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">w</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
<span class="p">},</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</code></pre></div>

<p>With our update function looking like&nbsp;so:</p>
<div class="highlight"><pre><span></span><code><span class="nx">update</span><span class="p">(</span><span class="nx">pixel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">checkMoves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">firstSide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">secondSide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;wall&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">firstSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">secondSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">firstSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">secondSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">move</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">checkMoves</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">inBounds</span><span class="p">(</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destIsPixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">pixels</span><span class="p">.</span><span class="nx">has</span><span class="p">([</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]]);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">destIsPixel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">movePixel</span><span class="p">(</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">pixel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Sand can move down, down-left and down-right. Water can also move sideways. Note that the order of the <code>checkMoves</code> array matters. For now, we also only allow pixels to move to empty spots. We&#8217;ll change that&nbsp;later.</p>
<p>You can play around with the result&nbsp;below:</p>
<div src="/iframes/cellular4/index-initial.html"
    class="toggle" scrolling="no" frameborder="0" width="660" height="460"></div>

<p>Obviously, this is not perfect yet (you&#8217;ll note that sand stacks on top of water), but before we fix that, there are a couple of other things to take care of. First of all, take a look at what happens if we drop&nbsp;water:</p>
<p><img alt="A horizontal gap pattern appears" src="/images/2020/water1.gif"></p>
<p>Not only does the water not flow naturally (it jumps to the right end), it also creates a strange horizontal gap pattern. The reason why this happens is due to the order by which we go over the columns in each&nbsp;row:</p>
<div class="highlight"><pre><span></span><code><span class="nx">visit_grid</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">nrRows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">--</span><span class="p">)</span>
<span class="w">        </span><span class="c1">// From left to right</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">nrCols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="nx">func</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>And how we defined our moves for&nbsp;water:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">firstSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">]);</span><span class="w">   </span><span class="c1">// Check right hand side</span>
<span class="w">    </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">secondSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">]);</span><span class="w">  </span><span class="c1">// Check left hand side</span>
<span class="p">}</span>
</code></pre></div>

<p>Imagine we have two water pixels with an empty space in between. Since we check from left to right, and we prefer to move right first, water will have a tendency to end up right-sided. Once there, the water creates gaps in between drops. The reason for this is because we first attempt to move a pixel to the right, then go right one step (which now has the previous pixel), can&#8217;t move it right again, so move it left, back to its original&nbsp;spot.</p>
<p>We need to solve this problem first. Perhaps, once we have moved a pixel once in the current loop, we should avoid moving it again in the same update. So we will use a dirty flag for pixels which gets set to false before each update, and then set to true once we have moved a pixel. Our update function then skips over dirty&nbsp;pixels.</p>
<p>You can play with the result&nbsp;below:</p>
<div src="/iframes/cellular4/index-dirty.html"
    class="toggle" scrolling="no" frameborder="0" width="660" height="460"></div>

<p>This stops the gap pattern, somewhat. Instead, we now get this oscillating back-and-forth&nbsp;behavior:</p>
<p><img alt="Oscillating behavior" src="/images/2020/water2.gif"></p>
<p>Additionally, water still doesn&#8217;t flow very&nbsp;naturally:</p>
<p><img alt="Oscillating behavior" src="/images/2020/water3.gif"></p>
<p>This is an issue which is hard to solve with single buffered simulation approaches, and is not trivial to fix. One common way is to alternate the direction of the update loop, e.g. based on the frame counter (in fact, the code we found above also does&nbsp;so):</p>
<div class="highlight"><pre><span></span><code><span class="nx">visit_grid</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">nrRows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">--</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">frameCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">nrCols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">            </span><span class="nx">frameCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">nrCols</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="nx">frameCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">x</span><span class="o">--</span><span class="p">)</span>
<span class="w">            </span><span class="nx">func</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Another way is to randomize the order in which moves are&nbsp;checked:</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">firstSide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">secondSide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">firstSide</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
</code></pre></div>

<p>This helps a bit, but still leads to behavior which is somewhat erratic (i.e. it can take a long time before a mass of water finds its stable, settled&nbsp;position):</p>
<div src="/iframes/cellular4/index-bf.html"
    class="toggle" scrolling="no" frameborder="0" width="660" height="460"></div>

<h1>Improving the&nbsp;Simulation</h1>
<p>How do we continue to improve the simulation to make this behave a bit&nbsp;better?</p>
<p>Basically, we&#8217;d like to solve the following issues for our water. First, we&#8217;d like it to flow downwards where possible as quick as possible. Second, once it has reached a stable state, we&#8217;d like to avoid some pixels from erratically moving left and right forever. Third, we also want a row of water to be neatly filled up when possible, without in-between&nbsp;gaps.</p>
<p>For the first problem, we could for instance consider higher-than-Moore rank neighborhoods, e.g. have water flow downwards move than one pixel away if there&#8217;s no solid blocking the path. This is what Noita and the code we found does. This could be done with a simple line ray check using <a href="https://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm">Bresenham&#8217;s line algorithm</a>. Alternatively, we could also go for a more full-on particle-simulation where we give each pixel a velocity vector. If we ensure this to be below the unit vector in size, pixels can still spread around in all directions but cannot mvoe past&nbsp;walls.</p>
<p>The second problem could be avoided by checking if there is an empty spot available in the row under the pixel the pixel could eventually end up at. This is an extensive check though, and if resort to implementing this, we&#8217;d actually not be far away from implementing realistic&nbsp;pressure.</p>
<p>However, we can also improve our situation by means of a simpler heuristic. That is, let&#8217;s assign assign each pixel a velocity vector as mentioned above, but let us bound it to point to the right or left only. When we do a move check, we prefer trying going in the same direction first for each pixel. When we bump into something at the same height of us, we wait one world update iteration before checking the moves again but already change the velocity to point to the other&nbsp;side:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">move</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">checkMoves</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">inBounds</span><span class="p">(</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">destIsPixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">pixels</span><span class="p">.</span><span class="nx">has</span><span class="p">([</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]]);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">sameHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">destIsPixel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">movePixel</span><span class="p">(</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">pixel</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sameHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Bump</span>
<span class="w">        </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lastvel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lastvel</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>The reason why we do the latter is because if we wouldn&#8217;t, we would again get oscillating one-gap patterns. We now arrive at an outcome which doesn&#8217;t handle all that&nbsp;badly:</p>
<div src="/iframes/cellular4/index-vel.html"
    class="toggle" scrolling="no" frameborder="0" width="660" height="460"></div>

<p>One thing you&#8217;ll notice is that water pixels will still glide along a surface without ever settling down. If you look closely, this also sometimes happens in Noita and even in the example we found previously (although it is hard to see due to the pixels being so small). To resolve this, we could have pixels settle down once they&#8217;ve moved (in the same row) for <em>n</em> steps, and bring them back to life if e.g. their neighborhood changes. For now, we&#8217;ll leave this is&nbsp;as.</p>
<h1>Handling&nbsp;Densities</h1>
<p>The next thing we need to tackle is believable material interaction. Let&#8217;s first add a couple more&nbsp;materials:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">WallMaterial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Material</span><span class="p">(</span><span class="s1">&#39;wall&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#8a522b&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">RockMaterial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Material</span><span class="p">(</span><span class="s1">&#39;rock&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#7d6d61&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">SandMaterial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Material</span><span class="p">(</span><span class="s1">&#39;sand&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#edc677&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">LavaMaterial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Material</span><span class="p">(</span><span class="s1">&#39;lava&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#852220&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">WaterMaterial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Material</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#77b0ed&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">OilMaterial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Material</span><span class="p">(</span><span class="s1">&#39;oil&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#ada88e&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">SteamMaterial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Material</span><span class="p">(</span><span class="s1">&#39;steam&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#bee6e5&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</code></pre></div>

<p>The second argument here refers to the density. The heavier, the more we want to have it float to the bottom. However, only gasses and water interact in this&nbsp;way.</p>
<p>We rework or update loop as follows (this getting a bit messy, but let&#8217;s keep it as is for the sake of showing one&nbsp;function):</p>
<div class="highlight"><pre><span></span><code><span class="nx">update</span><span class="p">(</span><span class="nx">pixel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">checkMoves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">firstSide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lastvel</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">secondSide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">firstSide</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">dirty</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;wall&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">firstSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">secondSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;sand&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;lava&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;water&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;oil&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">firstSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">secondSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;lava&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;water&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;oil&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">firstSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">secondSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">move</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">checkMoves</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">inBounds</span><span class="p">(</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destPixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">pixels</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]]);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destIsPixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">pixels</span><span class="p">.</span><span class="nx">has</span><span class="p">([</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]]);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destIsEqualY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destIsHigherDensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">destIsPixel</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">density</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">density</span><span class="p">;</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destIsLowerDensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">destIsPixel</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">density</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">density</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">destIsPixel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">movePixel</span><span class="p">(</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">pixel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">solid</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="p">((</span><span class="nx">destIsHigherDensity</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">                </span><span class="p">(</span><span class="nx">destIsLowerDensity</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">movePixel</span><span class="p">(</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">pixel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">destIsEqualY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lastvel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lastvel</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>And this is the result. Try playing around with water, steam, and oil and see how they&nbsp;interact:</p>
<div src="/iframes/cellular4/index-density.html"
    class="toggle" scrolling="no" frameborder="0" width="660" height="460"></div>

<p>(Of course, the real world is always more complex, even when aiming to handle the simplest concepts only. Sand, for instance, is in a kind of intermediate solid-fluid state where it actually would disperse in a different way under water. <a href="https://www.nytimes.com/2020/11/09/science/what-makes-sand-soft.html">It&#8217;s actually a very hard case for physics in general</a>.)</p>
<h1>Adding&nbsp;Interactions</h1>
<p>We&#8217;re almost done. The only thing left to do is add in a couple of interactions. Here is where we finally encounter a huge benefit of our single buffer approach. Contrary to a <span class="caps">CA</span> system, these are very easy to add in. We first give each pixel a life time which gets incremented every world update, and then simply slap in the following in our update function (we also add two new materials: wood and&nbsp;fire):</p>
<div class="highlight"><pre><span></span><code><span class="nx">update</span><span class="p">(</span><span class="nx">pixel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">checkMoves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">firstSide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lastvel</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">secondSide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">firstSide</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">dirty</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="o">++</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;wall&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;wood&#39;</span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;fire&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">firstSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">secondSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;sand&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;lava&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;water&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;oil&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;fire&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">firstSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">secondSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;lava&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;water&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;oil&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;fire&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">firstSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">secondSide</span><span class="p">,</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Special case for fire</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;fire&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checkMoves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shuffle</span><span class="p">(</span><span class="nx">checkMoves</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">move</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">checkMoves</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">inBounds</span><span class="p">(</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destPixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">pixels</span><span class="p">.</span><span class="nx">get</span><span class="p">([</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]]);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destIsPixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">pixels</span><span class="p">.</span><span class="nx">has</span><span class="p">([</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]]);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destIsEqualY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destIsHigherDensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">destIsPixel</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">density</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">density</span><span class="p">;</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">destIsLowerDensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">destIsPixel</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">density</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">density</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Interactions</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">destIsPixel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;lava&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SteamMaterial</span><span class="p">;</span>
<span class="w">                </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;lava&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;wood&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">FireMaterial</span><span class="p">;</span>
<span class="w">                </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;lava&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;oil&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">FireMaterial</span><span class="p">;</span>
<span class="w">                </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">WaterMaterial</span><span class="p">;</span>
<span class="w">                </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;fire&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;wood&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">FireMaterial</span><span class="p">;</span>
<span class="w">                </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;fire&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;oil&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">FireMaterial</span><span class="p">;</span>
<span class="w">                </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;fire&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">30</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SteamMaterial</span><span class="p">;</span>
<span class="w">                </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">removePixel</span><span class="p">(</span><span class="nx">pixel</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;lava&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">300</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">RockMaterial</span><span class="p">;</span>
<span class="w">                </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Movement</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">destIsPixel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">movePixel</span><span class="p">(</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">pixel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">destPixel</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">solid</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="p">((</span><span class="nx">destIsHigherDensity</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">                </span><span class="p">(</span><span class="nx">destIsLowerDensity</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">movePixel</span><span class="p">(</span><span class="nx">move</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">move</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">pixel</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">destIsEqualY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lastvel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">lastvel</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>We cheat a little bit by shuffling the movement candidates in the case of fire to make it behave more erratic, but other than this, the interactions are very self&nbsp;explanatory.</p>
<p>Here you can see me playing around with the result a&nbsp;bit:</p>
<p><img alt="Not so bad..." src="/images/2020/water4.gif"></p>
<p>And if you want to try for&nbsp;yourself:</p>
<div src="/iframes/cellular4/index-interact.html"
    class="toggle" scrolling="no" frameborder="0" width="660" height="460"></div>

<h1>Done For&nbsp;Now</h1>
<p>This has been a long post. The code fragments might seem out of place but you can easily inspect the non-obfuscated <span class="caps">JS</span> code in each of the iframes above should you want&nbsp;to.</p>
<p>There&#8217;s a couple of noteworthy things still to&nbsp;tackle:</p>
<ul>
<li>Note that the bottom-up world update still stands. This means that e.g. steam has a tendency to immediately disperse when drawn in a vertical line (you can see this above). Luckily, this doesn&#8217;t look too bad for&nbsp;gasses</li>
<li>We haven&#8217;t dealt with higher order neighborhoods at all. See the discussion on this above. However, this wouldn&#8217;t be too hard to add in at this stage, and we might do so in an eventual next part. More generally, we might want to go towards a more realistic particle-style approach where we give each pixel a real velocity vector. This could also help to &#8220;splash up&#8221; liquids when a solid falls into&nbsp;them</li>
<li>Multithreading hasn&#8217;t been dealt with at all &#8212; but this is deliberately not a focus here. I&#8217;m also quite honestly incapable to implement this in JavaScript and&nbsp;p5.js</li>
<li>The same goes for shaders and more effects. Again, this is a bare-bones as close to the basic simulation as we can get exercise. Not a full game&nbsp;engine</li>
<li>And similarly, rigid body physics are not dealt with at&nbsp;all</li>
<li>However, I am now convinced that single buffered simulation engines can be a viable and workable alternative for cellular automata. This comes with a lot of drawbacks (oscillation and so on), but also has nice benefits (interactions, more straightforward coding,&nbsp;faster)</li>
<li>Finally, something fun which we did tackle in an earlier part but didn&#8217;t do here was pressure. I mentioned above that even a heuristic approach to do this (Dwarf Fortress style) is quite expensive. However, I do have a weird alternative idea for this: what if we not only adopt a full-on particle systems for the pixels but perhaps also simulate each particle as a unit circle in a more modern physics engine with mass determined by the distance from the bottom row? This could be easily investigated with something like <a href="https://box2d.org/">Box2D</a>, I think. Maybe also something for&nbsp;later</li>
</ul>
<p>In any case, these are enough points to discuss for an optional Part 5, should it&nbsp;arrive.</p>
	</article>
</div>

		</div>

		<footer class="row">
			<div class="large-12 columns">
				<hr />
				<div class="row">
					<p>Bed Against The Wall by Seppe "Macuyiko" vanden Broucke<br>
						Unless mentioned otherwise, this work is licensed under a <a
							href="http://creativecommons.org/licenses/by-sa/2.0/be/" rel="license">Creative Commons
							Attribution-Share Alike 2.0 Belgium License</a>.<br>
						Static blog engine powered by <a href="http://getpelican.com">Pelican</a>.</p>
				</div>
			</div>
		</footer>
	</div>