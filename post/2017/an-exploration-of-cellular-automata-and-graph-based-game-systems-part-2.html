<!DOCTYPE html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width" />

	<title>An Exploration of Cellular Automata and Graph Based Game Systems: Part 2</title>

	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/normalize.css" />
	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/foundation.min.css" />
	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/style.css" />
	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/pygments.css" />
	<script src="//blog.macuyiko.com/theme/js/jquery-3.4.1.min.js"></script>
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css?family=Bitter:400,700|Source+Code+Pro&display=swap" rel="stylesheet">


	<script type="text/javascript">
		var waitForFinalEvent = (function () {
			var timers = {};
			return function (callback, ms, uniqueId) {
				if (!uniqueId) uniqueId = "_";
				if (timers[uniqueId]) clearTimeout(timers[uniqueId]);
				timers[uniqueId] = setTimeout(callback, ms);
			};
		})();
		var insertCaptions = function () {
			$('#articlecontainer .caption').remove();
			var width = $(window).width();
			var onmobile = width < 1400; //>
			var capclass = onmobile ? 'caption-below' : 'caption-aside';
			$.each($('#articlecontainer img'), function (index, value) {
				if ($(value).attr('alt') != undefined) {
					var elem = $('<div class="caption ' + capclass + '">' + $(value).attr('alt') + '</div>');
					if (onmobile) elem.insertAfter(value);
					else elem.insertBefore(value);
				}
			});
		};
		$(function () {
			$(window).resize(function () {
				waitForFinalEvent(function () {
					insertCaptions();
				}, 500, "window.resize");
			});
			insertCaptions();
		});
	</script>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-60406-11']);
		_gaq.push(['_trackPageview']);

		(function () {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
</head>

<body>

	<nav>
		<div class="top-bar large-12 columns">
			<h1><a href="//blog.macuyiko.com/">Bed Against The Wall</a></h1>
		</div>
	</nav>

	<div class="postheader">
		<div class="postheader-wrap">
			<img class="postheader-trans" src="data:image/gif;base64,R0lGODlhMgAVAPAAAP///wAAACH5BAEAAAAALAAAAAAyABUAAAIfhI+py+0Po5y02ouz3rz7D4biSJbmiabqyrbuC8dTAQA7">
			<img class="postheader-cover" src="/images/backgrounds/water.jpg">
		</div>
	</div>

	<div class="row contentwrapper">
		<div class="row">
<div id="articlecontainer" class="large-9 columns large-centered">
	<article>
		<header>
			<div class="article-info">Tue 19 December 2017, by Seppe "Macuyiko" vanden Broucke</div>
			<div class="article-title"><a href="//blog.macuyiko.com/post/2017/an-exploration-of-cellular-automata-and-graph-based-game-systems-part-2.html" rel="bookmark"
			title="Permalink to An Exploration of Cellular Automata and Graph Based Game Systems: Part 2">An Exploration of Cellular Automata and Graph Based Game Systems: Part&nbsp;2</a></div>
<div class="article-subtitle">Grid Based Fluid Systems</div>		</header>
	
	    <script>
$(function() {
    $('.toggle').each(function(index) {
        var toggler = $('<div style="margin: 8px 0; background-color: #E3E0FF; cursor: pointer; padding: 8px;">Toggle iframe</div>');
        toggler.insertBefore($(this));
        toggler.click(function() {
            var elt = $(this).next('.toggle');
            var newElt = $("<iframe></iframe>")
            Array.prototype.slice.call(elt.get(0).attributes).forEach(function(a) {
                newElt.attr(a.name, a.value);
            });
            if (!$(this).hasClass('toggled')) {
                elt.append(newElt);
                $(this).addClass('toggled');
            } else {
                elt.html('');
                $(this).removeClass('toggled');
            }
        });
    });
});
</script>

<p>This post is the second part on a small series on cellular automata and graph based systems as found in games. Part 1 can be found <a href="////blog.macuyiko.com/post/2017/an-exploration-of-cellular-automata-and-graph-based-game-systems-part-1.html">here</a>.</p>
<p>In our last past, we ended up with a general framework to construct cellular automata. To refresh, a cellular automaton is a discrete simulation defined over a grid of cells, each one of which is carrying a state. For each cell, a set of cells called its neighborhood is defined relative to the specified cell. From an initial state, a simulation is started where each new generation is created according to a set of rules that determines the new state of each cell in terms of the current state of the cell and the states of the cells in its&nbsp;neighborhood:</p>
<div class="highlight"><pre><span></span><code><span class="n">forever</span><span class="o">:</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">grid</span><span class="o">:</span>
<span class="w">        </span><span class="kd">get</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">neighborhood</span>
<span class="w">        </span><span class="n">determine</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">neighborhood</span>
<span class="w">        </span><span class="n">swap</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">grid</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">grid</span>
</code></pre></div>

<p>Left up to us is&nbsp;to:</p>
<ul>
<li>Define the neighborhood of a&nbsp;cell</li>
<li>Define the state of a&nbsp;cell</li>
<li>Define the rules to determine the state in a new&nbsp;generation</li>
</ul>
<p>Let&#8217;s now expand on this framework to simulate fluid dynamics as similarly as seen in games such as Oxygen Not Included, &#8220;<a href="https://en.wikipedia.org/wiki/Falling-sand_game">falling sand</a>&#8221; games, and so&nbsp;on.</p>
<h1>Some basic&nbsp;groundwork</h1>
<p>The main change we need to perform is to the definition of a cell&#8217;s state. Contrary to what we&#8217;ve been working with so far, our state now is going to be a tad more complex, allowing for some&nbsp;flexibility:</p>
<ul>
<li>A cell can hold a variable number of materials, each represented as a float in the range 0 (min) to 1&nbsp;(max)</li>
<li>To represent a cell, we&#8217;ll associate an <span class="caps">RGB</span> color to each material&nbsp;&#8220;type&#8221;</li>
<li>When drawing the grid, we simply use some alpha masking to overlay the colors on top of each&nbsp;other</li>
</ul>
<p>Regarding the rules to determine the next generation, we&#8217;re going to work with the concept of flow. Our rule system will be based on a general framework adhering to the following&nbsp;rules:</p>
<ul>
<li>First of all, make a copy of the current state and set it as the next state, this will ensure that cells where nothing happens or where some material is &#8220;left over&#8221; automatically carry this to the next generation without us always having to manually assign&nbsp;this</li>
<li>Define helper &#8220;remaining&#8221; variables for every cell to keep track of how much material can still be flowed out for that cell, as we want to ensure that we don&#8217;t flow out more material than was there in the current state (this is not necessary, but makes things much&nbsp;easier)</li>
<li>Next up, we visit every&nbsp;cell</li>
<li>Based on a collection of rules, we only allow materials to &#8220;flow out&#8221;, decreasing the &#8220;remaining&#8221; count and material count in the next state, and increasing the material count in the next state for one of the neighboring&nbsp;cells</li>
</ul>
<p>In&nbsp;pseudocode:</p>
<div class="highlight"><pre><span></span><code><span class="n">next_board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy</span><span class="p">(</span><span class="n">this_board</span><span class="p">)</span>
<span class="n">remaining_board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy</span><span class="p">(</span><span class="n">this_board</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">this_board</span><span class="p">:</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">rules</span><span class="p">,</span><span class="w"> </span><span class="n">perform</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">more</span><span class="p">:</span>
<span class="w">    </span><span class="n">flow</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="n">neighbor</span><span class="p">,</span><span class="w"> </span><span class="n">material</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span>
<span class="n">this_board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_board</span>

<span class="k">func</span><span class="w"> </span><span class="n">flow</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="n">neighbor</span><span class="p">,</span><span class="w"> </span><span class="n">material</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">):</span>
<span class="w">    </span><span class="n">cell</span><span class="o">.</span><span class="n">material</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">remaining_board</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span>
<span class="w">    </span><span class="n">cell</span><span class="o">.</span><span class="n">material</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">next_board</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span>
<span class="w">    </span><span class="n">neighbor</span><span class="o">.</span><span class="n">material</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">next_board</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amount</span>
</code></pre></div>

<h1>Basic&nbsp;example</h1>
<p>Let&#8217;s try out this approach using a simple system: one with sand and&nbsp;floors.</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">createCanvas</span><span class="p">(</span><span class="mf">520</span><span class="p">,</span><span class="w"> </span><span class="mf">320</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;sand&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;floor&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">floor</span><span class="p">(</span><span class="nx">width</span><span class="o">/</span><span class="nx">w</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">floor</span><span class="p">(</span><span class="nx">height</span><span class="o">/</span><span class="nx">w</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="mf">255</span><span class="p">,</span><span class="w"> </span><span class="mf">160</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">50</span><span class="p">,</span><span class="w"> </span><span class="mf">50</span><span class="p">,</span><span class="w"> </span><span class="mf">50</span><span class="p">]];</span>
<span class="w">    </span><span class="nx">grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Grid</span><span class="p">(</span><span class="nx">cols</span><span class="p">,</span><span class="w"> </span><span class="nx">rows</span><span class="p">,</span><span class="w"> </span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">types</span><span class="p">,</span><span class="w"> </span><span class="nx">colors</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Using the following simple update&nbsp;rule:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">tick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">downMaxSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Fall sand</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">bottom</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">bottom</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;floor&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">sandHere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;sand&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">spaceBelow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">bottom</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;sand&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">flow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">constrain</span><span class="p">(</span><span class="nx">sandHere</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">downMaxSpeed</span><span class="p">,</span><span class="w"> </span><span class="nx">spaceBelow</span><span class="p">));</span>
<span class="w">        </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">bottom</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sand&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">flow</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>You can play around with the result here. Tip: pressing <code>o</code> cycles through the different material types to draw, <code>p</code> (un)pauses the simulation, <code>d</code> toggles debugging mode. Press <code>r</code> to reset everything. You might need to click inside first to give the iframe&nbsp;focus.</p>
<div src="/iframes/cellular2/index.basic.html"
    class="toggle" scrolling="no" frameborder="0" width="520" height="320"></div>

<h1>Introducing&nbsp;water</h1>
<p>This basic example is not that impressive yet. Let&#8217;s change things up a bit by defining a system for water instead. Our update rules now look as&nbsp;follows:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">tick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">downMaxSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Water falls downwards</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">waterHere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">bottomPassable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isPassable</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;bottom&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">bottomPassable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">spaceBelow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">bottom</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">flow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">constrain</span><span class="p">(</span><span class="nx">waterHere</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">downMaxSpeed</span><span class="p">,</span><span class="w"> </span><span class="nx">spaceBelow</span><span class="p">));</span>
<span class="w">        </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">bottom</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">flow</span><span class="p">);</span>
<span class="w">        </span><span class="nx">waterHere</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">flow</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// And also sideways if their&#39;s a floor beneath or lots of water</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">waterDown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bottomPassable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">down</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">waterDown</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.8</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">waterHere</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">sideFlow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getWaterSideOutFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">waterHere</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sideFlow</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">        </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sideFlow</span><span class="p">[</span><span class="mf">0</span><span class="p">]);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sideFlow</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">        </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">right</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sideFlow</span><span class="p">[</span><span class="mf">1</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">waterHere</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">sideFlow</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">sideFlow</span><span class="p">[</span><span class="mf">1</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p><code>getWaterSideOutFlow</code> is a helper function which determines how much water should be flown out to the left and right respectively to reach a &#8220;stable&#8221;&nbsp;level:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">getWaterSideOutFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">currentWater</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">divider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">totalWater</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentWater</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">doLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isPassable</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">        </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">left</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">currentWater</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">doRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isPassable</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;right&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">        </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">right</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">currentWater</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">doLeft</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">divider</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="nx">totalWater</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">left</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">doRight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">divider</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="nx">totalWater</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">right</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">stableLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">totalWater</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">divider</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">toLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">isPassable</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">stableLevel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">left</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">toRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">isPassable</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;right&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">stableLevel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">right</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">toLeft</span><span class="p">,</span><span class="w"> </span><span class="nx">toRight</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>

<p>Of course, we could play around with this &#8212; a much easier option is to move water around to the left or right randomly (which is the option many systems go for), though this leads to a kind of jittery&nbsp;effect.</p>
<p>You can play around with the result below. Again: pressing <code>o</code> cycles through the different material types to draw, <code>p</code> (un)pauses the simulation, <code>d</code> toggles debugging mode. Press <code>r</code> to reset everything. The simulation below starts from a preset scenario, though feel free to play around with this (break a hole in one of the walls, for instance). One interesting aspect you&#8217;ll note is that this simulation does not adhere to &#8220;real&#8221; pressure dynamics (i.e. modeling &#8220;<a href="https://en.wikipedia.org/wiki/Communicating_vessels">communicating vessels</a>&#8221; is not working here). This is another aspect most cellular automaton based systems fail to model correctly and something we&#8217;ll fix in a&nbsp;bit.</p>
<div src="/iframes/cellular2/index.water.html"
    class="toggle" scrolling="no" frameborder="0" width="520" height="320"></div>

<h1>Fixing&nbsp;pressure</h1>
<p>Let&#8217;s expand on the previous example a bit to fix the communicating vessel issue. First, we&#8217;ll add to general purpose methods as follows (note how the &#8220;remaining&#8221; variables come into play&nbsp;here):</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">doVerticalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">direction</span><span class="p">,</span><span class="w"> </span><span class="nx">speed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">speed</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">passable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isPassable</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">direction</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">liquid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">passable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">room</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">[</span><span class="nx">direction</span><span class="p">].</span><span class="nx">next</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">flow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">constrain</span><span class="p">(</span><span class="nx">liquid</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">speed</span><span class="p">,</span><span class="w"> </span><span class="nx">room</span><span class="p">));</span>
<span class="w">    </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">[</span><span class="nx">direction</span><span class="p">],</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">flow</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">doHorizontalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">direction</span><span class="p">,</span><span class="w"> </span><span class="nx">viscosity</span><span class="p">,</span><span class="w"> </span><span class="nx">stickyness</span><span class="p">,</span><span class="w"> </span><span class="nx">fluidity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">viscosity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">viscosity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">stickyness</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">stickyness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">fluidity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">fluidity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">passable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isPassable</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">direction</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">support</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">passable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">[</span><span class="nx">direction</span><span class="p">].</span><span class="nx">current</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">liquid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">support</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">viscosity</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">liquid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">stickyness</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">sideFlow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getSideOutFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sideFlow</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">        </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">sideFlow</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">/</span><span class="nx">fluidity</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sideFlow</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">        </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">right</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">sideFlow</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">/</span><span class="nx">fluidity</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>These will be used to update down/upwards (vertical) and side (horizontal) flow respectively, with several parameters to set to determine the &#8220;stickyness&#8221; and so on of horizontal&nbsp;flow.</p>
<p>To handle pressure, we&#8217;ll utilize a similar &#8220;teleportation&#8221; trick as done in <a href="http://dwarffortresswiki.org/index.php/v0.34:Flow#Fluids_under_pressure.2C_aka_Teleportation">Dwarf Fortress</a>:</p>
<blockquote>
<p>Fluids moving under pressure do not just move to adjacent tiles, they also trace a path through other full tiles of fluid trying to move to more distant tiles. Fluids moving under pressure can effectively teleport through other tiles that are already filled with fluid. When teleporting, fluids do not generate any flow, neither will they push objects&nbsp;around.</p>
</blockquote>
<p>This is handled by the following&nbsp;functions:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">isPressured</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">direction</span><span class="p">,</span><span class="w"> </span><span class="nx">liquid</span><span class="p">,</span><span class="w"> </span><span class="nx">minliquid</span><span class="p">,</span><span class="w"> </span><span class="nx">minpressure</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">passable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isPassable</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">direction</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">pressure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">passable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">[</span><span class="nx">direction</span><span class="p">].</span><span class="nx">current</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">pressured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pressure</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">minpressure</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">liquid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">minliquid</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">pressured</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">doPressureFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">direction</span><span class="p">,</span><span class="w"> </span><span class="nx">minliquid</span><span class="p">,</span><span class="w"> </span><span class="nx">minpressure</span><span class="p">,</span><span class="w"> </span><span class="nx">connectedliquid</span><span class="p">,</span><span class="w"> </span><span class="nx">minflow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">minliquid</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">minliquid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">minpressure</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">minpressure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">connectedliquid</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">connectedliquid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">minflow</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">minflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">liquid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">pressured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isPressured</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">direction</span><span class="p">,</span><span class="w"> </span><span class="nx">liquid</span><span class="p">,</span><span class="w"> </span><span class="nx">minliquid</span><span class="p">,</span><span class="w"> </span><span class="nx">minpressure</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">pressured</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Find a lower connected tile that is also pressured</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">expansion_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">done_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">expand</span><span class="p">(</span><span class="nx">expansion_list</span><span class="p">,</span><span class="w"> </span><span class="nx">done_list</span><span class="p">,</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">directions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;left&#39;</span><span class="w"> </span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;down&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">directions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">[</span><span class="nx">directions</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="w"> </span>
<span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">isPassable</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">directions</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
<span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">done_list</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">[</span><span class="nx">directions</span><span class="p">[</span><span class="nx">i</span><span class="p">]])</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">expansion_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">[</span><span class="nx">directions</span><span class="p">[</span><span class="nx">i</span><span class="p">]]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">thatneighborhood</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">flow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="nx">expand</span><span class="p">(</span><span class="nx">expansion_list</span><span class="p">,</span><span class="w"> </span><span class="nx">done_list</span><span class="p">,</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">expansion_list</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">expansion_list</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
<span class="w">        </span><span class="nx">done_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
<span class="w">        </span><span class="nx">thatneighborhood</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">neighborhood</span><span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">col</span><span class="p">,</span><span class="w"> </span><span class="nx">todo</span><span class="p">.</span><span class="nx">row</span><span class="p">);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">thatliquid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">thatneighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">thatpressured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isPressured</span><span class="p">(</span><span class="nx">thatneighborhood</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">direction</span><span class="p">,</span><span class="w"> </span><span class="nx">thatliquid</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">minpressure</span><span class="p">);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;up&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span>
<span class="w">            </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">row</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">thatneighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">row</span><span class="w"> </span><span class="o">:</span>
<span class="w">            </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">thatneighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">row</span><span class="p">;</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">room</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">thatneighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">maxFlow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">liquid</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">thatliquid</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">        </span><span class="nx">flow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">constrain</span><span class="p">(</span><span class="nx">liquid</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">maxFlow</span><span class="p">,</span><span class="w"> </span><span class="nx">room</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">thatliquid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">liquid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">thatpressured</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">check</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">flow</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.1</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">thatneighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">connectedliquid</span><span class="p">)</span>
<span class="w">            </span><span class="nx">expand</span><span class="p">(</span><span class="nx">expansion_list</span><span class="p">,</span><span class="w"> </span><span class="nx">done_list</span><span class="p">,</span><span class="w"> </span><span class="nx">thatneighborhood</span><span class="p">);</span>
<span class="w">        </span><span class="nx">thatneighborhood</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">thatneighborhood</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="nx">thatneighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">flow</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Putting everything together in our update rule&nbsp;set:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">tick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">doVerticalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="nx">doHorizontalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.7</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="nx">doPressureFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;up&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>We get the following result. Again: pressing <code>o</code> cycles through the different material types to draw, <code>p</code> (un)pauses the simulation, <code>d</code> toggles debugging mode. Press <code>r</code> to reset everything. Note how the &#8220;vessels&#8221; now stabilize (try filling up one side by drawing some water in the&nbsp;air):</p>
<div src="/iframes/cellular2/index.pressure.html"
    class="toggle" scrolling="no" frameborder="0" width="520" height="320"></div>

<h1>Expansion</h1>
<p>Expanding on this system is now relatively easy. The following simulation defines three new material types: lava, steam, and ice. Cells that mix lava and water will convert this water to steam, which flows upwards in a more random manner (to allow steam to linger in a cell from time to time). When steam touches an ice block in one of its neighbors, it converts back to water. The teleportation trick is only used for water in the simulation&nbsp;below:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">tick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">doVerticalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="nx">doVerticalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lava&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="nx">doHorizontalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.7</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="nx">doHorizontalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lava&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">random</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">random</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">19</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">doVerticalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">doVerticalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;up&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">random</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">doHorizontalFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;up&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="s1">&#39;lava&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">vaporation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">),</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="s1">&#39;lava&#39;</span><span class="p">));</span>
<span class="w">            </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">vaporation</span><span class="p">);</span>
<span class="w">            </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nx">vaporation</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">icenearby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">up</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">up</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="s1">&#39;ice&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">down</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">down</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="s1">&#39;ice&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>
<span class="w">            </span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">left</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">left</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="s1">&#39;ice&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>
<span class="w">            </span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">right</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">right</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="s1">&#39;ice&#39;</span><span class="p">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="s1">&#39;steam&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">icenearby</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">vaporation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">remaining</span><span class="p">(</span><span class="s1">&#39;steam&#39;</span><span class="p">),</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="w">            </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;steam&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">vaporation</span><span class="p">);</span>
<span class="w">            </span><span class="nx">neighborhood</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nx">vaporation</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">doPressureFlow</span><span class="p">(</span><span class="nx">neighborhood</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;water&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;up&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>You can play around with the result below. Again: pressing <code>o</code> cycles through the different material types to draw, <code>p</code> (un)pauses the simulation, <code>d</code> toggles debugging mode. Press <code>r</code> to reset everything. The initial setup loads in a closed system where water is heated, cycled, and cooled&nbsp;down:</p>
<div src="/iframes/cellular2/index.lava.html"
    class="toggle" scrolling="no" frameborder="0" width="520" height="320"></div>

<h1>Conclusion</h1>
<p>We&#8217;ve now seen the basics regarding the use of cellular automata to simulate simple systems. Based on our framework we have constructured, it&#8217;s now easy to add in further material types and&nbsp;interactions.</p>
<p>Next time, we switch gears and move away from cellular automata to graph based systems, another often-utilized concept in games, though we&#8217;ll see that there is some overlap with cellular automata as&nbsp;well.</p>
	</article>
</div>

		</div>

		<footer class="row">
			<div class="large-12 columns">
				<hr />
				<div class="row">
					<p>Bed Against The Wall by Seppe "Macuyiko" vanden Broucke<br>
						Unless mentioned otherwise, this work is licensed under a <a
							href="http://creativecommons.org/licenses/by-sa/2.0/be/" rel="license">Creative Commons
							Attribution-Share Alike 2.0 Belgium License</a>.<br>
						Static blog engine powered by <a href="http://getpelican.com">Pelican</a>.</p>
				</div>
			</div>
		</footer>
	</div>